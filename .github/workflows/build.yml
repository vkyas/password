name: build

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-24.04
    env:
      PHP_VERSION: 8.3.8
      API_LEVEL: 22
      ARCH: armv7a
      TARGET: arm-linux-androideabi
      NDK_VERSION: r25c
      WORKDIR: build-arm32
      OUTDIR: output-arm32

      NDK: /home/runner/work/password/password/android-ndk-r25c
      TOOLCHAIN: /home/runner/work/password/password/android-ndk-r25c/toolchains/llvm/prebuilt/linux-x86_64
      CC: /home/runner/work/password/password/android-ndk-r25c/toolchains/llvm/prebuilt/linux-x86_64/bin/arm-linux-androideabi22-clang
      CXX: /home/runner/work/password/password/android-ndk-r25c/toolchains/llvm/prebuilt/linux-x86_64/bin/arm-linux-androideabi22-clang++
      AR: /home/runner/work/password/password/android-ndk-r25c/toolchains/llvm/prebuilt/linux-x86_64/bin/llvm-ar
      RANLIB: /home/runner/work/password/password/android-ndk-r25c/toolchains/llvm/prebuilt/linux-x86_64/bin/llvm-ranlib
      STRIP: /home/runner/work/password/password/android-ndk-r25c/toolchains/llvm/prebuilt/linux-x86_64/bin/llvm-strip
      SYSROOT: /home/runner/work/password/password/android-ndk-r25c/toolchains/llvm/prebuilt/linux-x86_64/sysroot
      PATH: /home/runner/work/password/password/android-ndk-r25c/toolchains/llvm/prebuilt/linux-x86_64/bin:/usr/local/bin:/usr/bin:/bin

    steps:
    - name: üì• Checkout source
      uses: actions/checkout@v4

    - name: üìö Build dependencies
      run: |
        chmod +x .github/scripts/build-deps.sh
        bash .github/scripts/build-deps.sh

    - name: ‚öôÔ∏è Configure PHP
      run: |
        mkdir -p $WORKDIR && cd $WORKDIR
        wget https://www.php.net/distributions/php-${PHP_VERSION}.tar.xz
        tar -xf php-${PHP_VERSION}.tar.xz
        cd php-${PHP_VERSION}

        export CPPFLAGS="-I$(pwd)/../../../deps/include"
        export LDFLAGS="-L$(pwd)/../../../deps/lib"
        export PKG_CONFIG_PATH="$(pwd)/../../../deps/lib/pkgconfig"

        ./configure \
          --host=$TARGET \
          --prefix=$(pwd)/../../../$OUTDIR \
          --with-sysroot=$SYSROOT \
          --disable-all \
          --enable-cli \
          --enable-mbstring \
          --enable-libxml \
          --enable-pdo \
          --with-pdo-mysql \
          --with-curl \
          --with-openssl \
          --with-zlib \
          --with-iconv \
          --with-libxml \
          --with-jpeg \
          --with-png \
          --with-freetype \
          --enable-gd \
          --enable-sockets \
          --without-pear

    - name: üß± Compile PHP
      run: |
        cd $WORKDIR/php-${PHP_VERSION}
        make -j$(nproc) V=1 || (cat config.log && false)
        make install

    - name: üì§ Upload Output
      uses: actions/upload-artifact@v4
      with:
        name: php-arm32-output
        path: ${{ env.OUTDIR }}
